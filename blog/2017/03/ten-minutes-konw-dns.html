<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>
     十分钟了解DNS - 沉默的大树 
  </title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
</head>

<body>
  <div id="layout">
    <a href="#menu" id="menuLink" class="menu-link">
      <span></span>
    </a>
    <div id="menu">
      <a class="pure-menu-header" href="https://cmdtree.com">沉默的大树</a>
      <div class="pure-menu">
        <ul class="pure-menu-list">
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com">
              Home</a>
          </li>
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="/about.html">
              </i>About</a>
          </li>
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="/contact.html">
              </i>Contact</a>
          </li>
          <!--
              <li class="pure-menu-item">
                <a class="pure-menu-link" href="https://cmdtree.com/index.xml">
                  <i class="fa fa-rss fa-fw"></i>RSS</a>
              </li> -->
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://github.com/rhatyang" target="_blank">
              </i>GitHub</a>
          </li>
        </ul>
        <ul class="pure-menu-list category-list">
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/network.html">网络技术与安全
              <span>(9)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/use.html">使用笔记
              <span>(47)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/learn.html">学习笔记
              <span>(29)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/history.html">历史爱好者
              <span>(3)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/lifetime.html">晃眼一生
              <span>(17)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/linux.html">Unix/Linux
              <span>(15)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/javascript.html">JavaScript
              <span>(36)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/other.html">杂文
              <span>(5)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/review.html">观后感
              <span>(2)</span>
            </a>
          </li>
          
          <li class="pure-menu-item">
            <a class="pure-menu-link" href="https://cmdtree.com/blog/python.html">Python
              <span>(2)</span>
            </a>
          </li>
          
        </ul>
      </div>
      <div class="menu-footer">
        <div class="small-print copyright">
          © 2018. All rights reserved.
        </div>
        <div class="small-print powered">
          Powered by Node.js. Open Source on
          <a href="https://github.com/rhatyang/cmdtree" target="_blank">Github</a>.
        </div>
        <div class="small-print">
          所有内容根据
          <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" target="_blank">CC BY 4.0</a>
          协议进行开源
        </div>
        <div class="last-updated small-print">
          最后一次更新在：2018年3月4日
        </div>
      </div>
    </div>
    <div id="main">
      
<article class="content page" itemscope itemtype="http://schema.org/Blogpageing">
  <div class="page-header">
    <h1 class="page-title">十分钟了解DNS</h1>
    <div class="page-meta">
      <p><time datetime="2017-03-18" itemprop="datePublished">日期：2017年03月18日</time></p>
      <span class="post-category">分类：网络技术与安全</span>
    </div>
  </div>
  <div class="page-content" itemprop="articleBody">
    <h1>一.hosts</h1>
<p>由于IP地址不便记忆，所以产生了域名（一种主机识别码的东西，为每台主机赋予<strong>唯一主机名</strong>）,为此需要有<code>hostName -&gt; IP</code>的机制，主机利用一个<code>hosts</code>的数据库文件来实现。</p>
<blockquote>
<p>hosts文件是一个用于<strong>储存计算机网络中各节点信息</strong>的计算机文件。这个文件负责<strong>将主机名称映射到相应的IP地址</strong>。hosts文件通常用于补充或替换网络中DNS的功能。和DNS不同的是，计算机的用户可以直接对hosts文件进行控制。</p>
</blockquote>
<p><strong>hosts文件作用：</strong></p>
<p>1.主机名到IP地址的映射</p>
<p>2.重定向， 如将server_a 重定向到其他IP。</p>
<p>3.减少对DNS服务器的访问来加快访问速度并减少带宽消耗。</p>
<p>对于重定向，有很好的作用，如：</p>
<p>将网易163.com 重定向到一个其他IP地址，比如重定向到一个另一个网站, 可以这样做：</p>
<pre><code class="hljs"># sudo vim /etc/hosts
123.53.214.30 163.com
</code></pre>
<p>如果想屏蔽一个网站，如百度，可以这样做, 该网站的域名映射到错误的IP或自己计算机的IP:</p>
<pre><code class="hljs">127.0.0.1 屏蔽的网站
0.0.0.0 屏蔽的网站
</code></pre>
<p>如下是屏蔽前后的效果：</p>
<pre><code class="hljs">$ curl baidu.com
&lt;html&gt;
&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=http://www.baidu.com/&quot;&gt;
&lt;/html&gt;

# 屏蔽后
$ curl baidu.com                        
curl: (7) Failed to connect to baidu.com port 80: Connection refused
</code></pre>
<p>如果你想加速一个网站的访问，跳过DNS解析的部分，因为有些国外的网站DNS解析太慢，更改hosts文件可减少解析，直接访问。比如加速github的访问：</p>
<pre><code class="hljs">185.31.17.185 github.global.ssl.fastly.net
</code></pre>
<p>还比如<a href="https://github.com/racaljk/hosts">最新可用的google hosts文件</a></p>
<p>如果对一些数据库服务器，访问时输入IP地址不能访问的，只能输入服务器名才能访问。那么我们配置好Hosts文件，这样输入服务器名就能顺利连接了。</p>
<h1>二.DNS</h1>
<h2>2.1 dns</h2>
<p>光hosts肯定不行，它只是个本地补充而已，需要一个大的系统来管理主机名和IP地址映射关系，这就是DNS. 如下解析流程：</p>
<p><img src="/pics/2017/03/2801.png" alt=""></p>
<p>域名分类如下：</p>
<p><img src="/pics/2017/03/2802.jpg" alt=""></p>
<p>每一层都有域名服务器，如通过域名查找一个网站过程</p>
<p><img src="/pics/2017/03/2803.jpg" alt=""></p>
<p>DNS如同互联网中的分布式数据库，主机名-&gt;IP只是其中的一部分，主机名-&gt;IP 的对应信息叫<strong>A记录</strong>，IP-&gt;主机名 的信息叫<strong>PTR</strong>, 上层或下层域名服务器IP地址的映射信息叫<strong>NS记录</strong>； 邮件地址与邮件服务器主机名的映射信息叫<strong>MX记录</strong>.</p>
<h2>2.2 域名解析</h2>
<h3>2.2.1 A记录</h3>
<p>即<strong>IP指向</strong>，对于<strong>泛域名解析</strong>即将该域名所有未指定的子域名都指向一个空间。在“主机名”中填入<code>*</code>，类型为A.</p>
<h3>2.2.2 CNAME</h3>
<p><strong>别名指向</strong>, 为一个主机设置别名, 比如用github page 来写博客，那么在CNAME文件中写你的域名，如beginman.cn， 然后取解析。那么就问 rhatyang.github.io 设定了一个叫 fanzhiyang.cn的别名，也就是绑定了自己的域名。注意，CNAME的目标主机地址<strong>只能使用主机名</strong>，不能使用IP地址；主机名前不能有任何其他前缀，如：http://等是不被允许的；A记录优先于CNAME记录。即如果一个主机地址同时存在A记录和CNAME记录，则CNAME记录不生效。</p>
<h3>2.2.3 NS记录</h3>
<blockquote>
<p>解析服务器记录。<strong>用来表明由哪台服务器对该域名进行解析</strong>。这里的NS记录只对子域名生效。</p>
</blockquote>
<p>如用户希望由IP为xx.xx.xx.xxx或域名为ns.mydomain.com这台服务器来解析xx.mydomain.com，则需要设置xx.mydomain.com的NS记录。NS记录优先于A记录。</p>
<h1>三、Linux DNS处理</h1>
<p>Linux有两个相关命令，<code>nslookup</code>和<code>dig</code>, ns也就是name servers缩写, 对域名解析检查方法：</p>
<pre><code class="hljs">$ nslookup -q=a www.youdomain.com
</code></pre>
<p>如果返回的记录只有一个IP且是当前使用的主机IP，则解析正常。如果返回的记录有多个IP地址，则解析有问题，需要修改解析。</p>
<p>如解析zhihu域名</p>
<pre><code class="hljs">$ nslookup www.zhihu.com
Server:        223.5.5.5          # DNS服务器的主机名
Address:    223.5.5.5#53           # DNS服务器IP地址

Non-authoritative answer:       # 非权威服务器的应答
www.zhihu.com    canonical name = eclipse.zhihu.com.   # cname = eclipse.zhihu.com. 别名

Name:    eclipse.zhihu.com         # 解析的URL
Address: 115.159.241.25         # 解析出来的IP

Name:    eclipse.zhihu.com
Address: 115.159.241.95
</code></pre>
<p>要了解上面的这些输出，就要搞清楚DNS的整个解析过程， 参考<a href="http://blog.csdn.net/crazw/article/details/8986504">DNS解析过程详解</a>:</p>
<p>1.现在我有一台计算机，通过ISP接入了互联网，那么ISP就会给我分配一个DNS服务器，这个DNS服务器不是权威服务器，而是相当于一个代理的dns解析服务器，他会帮你迭代权威服务器返回的应答，然后把最终查到IP返回给你。</p>
<p>2.现在的我计算机要向这台ISPDNS发起请求查询www.zhihu.com这个域名了，(这里准确来说不是ISPDNS，而应该是用户自己电脑网络设置里的DNS，并不一定是ISPDNS。比如也有可能你手工设置了8.8.8.8)</p>
<p>3.ISPDNS拿到请求后，先检查一下自己的缓存中有没有这个地址，有的话就直接返回。这个时候拿到的ip地址，会被标记为非权威服务器的应答。</p>
<p>4.如果缓存中没有的话，ISPDNS会从配置文件里面读取13个根域名服务器的地址（这些地址是不变的，直接在BIND的配置文件中）</p>
<p>5.然后像其中一台发起请求。</p>
<p>6.根服务器拿到这个请求后，知道他是com.这个顶级域名下的，所以就会返回com域中的NS记录，一般来说是13台主机名和IP。</p>
<p>7.然后ISPDNS向其中一台再次发起请求，com域的服务器发现你这请求是zhihu.com这个域的，我一查发现了这个域的NS，那我就返回给你，你再去查</p>
<p>8.ISPDNS不厌其烦的再次向zhihu.com这个域的权威服务器发起请求，zhihu.com收到之后，查了下有www的这台主机，就把这个IP返回给你了</p>
<p>9.然后ISPDNS拿到了之后，将其返回给了客户端，并且把这个保存在高速缓存中。</p>
<p>第一步ISP接入互联网分配的DNS服务器是动态的，在/etc/resolv.conf文件里，具体可参考<a href="http://www.centoscn.com/CentOS/config/2013/0723/443.html">DNS域名解析的配置文件/etc/resolv.conf</a></p>
<pre><code class="hljs">$ cat /etc/resolv.conf
#
# Mac OS X Notice
#
# This file is not used by the host name and address resolution
# or the DNS query routing mechanisms used by most processes on
# this Mac OS X system.
#
# This file is automatically generated.
#
nameserver 223.5.5.5
nameserver 119.29.29.29
nameserver 8.8.8.8
nameserver 114.114.114.114
</code></pre>
<p><img src="/pics/2017/03/2804.jpg" alt=""></p>
<p>用<code>dig</code>工具来跟踪一下:</p>
<pre><code class="hljs">$ dig +trace www.zhihu.com

# 第一步是向我这台机器的ISPDNS获取到根(`.`)域服务区的13个IP和主机名[b-j].root-servers.NET.
; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; +trace www.zhihu.com
;; global options: +cmd
.            143034    IN    NS    m.root-servers.net.
.            143034    IN    NS    a.root-servers.net.
.            143034    IN    NS    g.root-servers.net.
.            143034    IN    NS    d.root-servers.net.
.            143034    IN    NS    c.root-servers.net.
.            143034    IN    NS    k.root-servers.net.
.            143034    IN    NS    h.root-servers.net.
.            143034    IN    NS    j.root-servers.net.
.            143034    IN    NS    i.root-servers.net.
.            143034    IN    NS    f.root-servers.net.
.            143034    IN    NS    e.root-servers.net.
.            143034    IN    NS    l.root-servers.net.
.            143034    IN    NS    b.root-servers.net.
;; Received 525 bytes from 223.5.5.5#53(223.5.5.5) in 196 ms

# 第二步是向其中的一台根域服务器（Servername就是末行小括号里面的）发送www.zhihu.com的查询请求，返回了`com.`顶级域的服务器IP（未显示）和名称

com.            172800    IN    NS    d.gtld-servers.net.
com.            172800    IN    NS    k.gtld-servers.net.
com.            172800    IN    NS    g.gtld-servers.net.
com.            172800    IN    NS    c.gtld-servers.net.
com.            172800    IN    NS    e.gtld-servers.net.
com.            172800    IN    NS    m.gtld-servers.net.
com.            172800    IN    NS    h.gtld-servers.net.
com.            172800    IN    NS    i.gtld-servers.net.
com.            172800    IN    NS    a.gtld-servers.net.
com.            172800    IN    NS    b.gtld-servers.net.
com.            172800    IN    NS    f.gtld-servers.net.
com.            172800    IN    NS    l.gtld-servers.net.
com.            172800    IN    NS    j.gtld-servers.net.
;; Received 491 bytes from 192.203.230.10#53(192.203.230.10) in 672 ms

# 第三步，便向`com.`域的一台服务器192.203.230.10请求,www.zhihu.com，他返回了`zhihu.com`域的服务器IP（未显示）和名称，知乎有2台顶级域的服务器

zhihu.com.        172800    IN    NS    ns3.dnsv4.com.
zhihu.com.        172800    IN    NS    ns4.dnsv4.com.
;; Received 393 bytes from 192.43.172.30#53(192.43.172.30) in 240 ms

# 第四步，向知乎的顶级域服务器（192.43.172.30）请求www.zhihu.com，他发现这个www有个别名，而不是一台主机，别名是eclipse.zhihu.com
www.zhihu.com.        120    IN    CNAME    eclipse.zhihu.com.
eclipse.zhihu.com.    600    IN    A    115.159.241.95
eclipse.zhihu.com.    600    IN    A    115.159.241.25
zhihu.com.        86400    IN    NS    ns4.dnsv4.com.
zhihu.com.        86400    IN    NS    ns3.dnsv4.com.
;; Received 148 bytes from 183.232.90.141#53(183.232.90.141) in 60 ms
$ dig +trace www.zhihu.com

# 第一步是向我这台机器的ISPDNS获取到根(`.`)域服务区的13个IP和主机名[b-j].root-servers.NET.
; &lt;&lt;&gt;&gt; DiG 9.8.3-P1 &lt;&lt;&gt;&gt; +trace www.zhihu.com
;; global options: +cmd
.            143034    IN    NS    m.root-servers.net.
.            143034    IN    NS    a.root-servers.net.
.            143034    IN    NS    g.root-servers.net.
.            143034    IN    NS    d.root-servers.net.
.            143034    IN    NS    c.root-servers.net.
.            143034    IN    NS    k.root-servers.net.
.            143034    IN    NS    h.root-servers.net.
.            143034    IN    NS    j.root-servers.net.
.            143034    IN    NS    i.root-servers.net.
.            143034    IN    NS    f.root-servers.net.
.            143034    IN    NS    e.root-servers.net.
.            143034    IN    NS    l.root-servers.net.
.            143034    IN    NS    b.root-servers.net.
;; Received 525 bytes from 223.5.5.5#53(223.5.5.5) in 196 ms

# 第二步是向其中的一台根域服务器（Servername就是末行小括号里面的）发送www.zhihu.com的查询请求，返回了`com.`顶级域的服务器IP（未显示）和名称

com.            172800    IN    NS    d.gtld-servers.net.
com.            172800    IN    NS    k.gtld-servers.net.
com.            172800    IN    NS    g.gtld-servers.net.
com.            172800    IN    NS    c.gtld-servers.net.
com.            172800    IN    NS    e.gtld-servers.net.
com.            172800    IN    NS    m.gtld-servers.net.
com.            172800    IN    NS    h.gtld-servers.net.
com.            172800    IN    NS    i.gtld-servers.net.
com.            172800    IN    NS    a.gtld-servers.net.
com.            172800    IN    NS    b.gtld-servers.net.
com.            172800    IN    NS    f.gtld-servers.net.
com.            172800    IN    NS    l.gtld-servers.net.
com.            172800    IN    NS    j.gtld-servers.net.
;; Received 491 bytes from 192.203.230.10#53(192.203.230.10) in 672 ms

# 第三步，便向`com.`域的一台服务器192.203.230.10请求,www.zhihu.com，他返回了`zhihu.com`域的服务器IP（未显示）和名称，知乎有2台顶级域的服务器

zhihu.com.        172800    IN    NS    ns3.dnsv4.com.
zhihu.com.        172800    IN    NS    ns4.dnsv4.com.
;; Received 393 bytes from 192.43.172.30#53(192.43.172.30) in 240 ms

# 第四步，向知乎的顶级域服务器（192.43.172.30）请求www.zhihu.com，他发现这个www有个别名，而不是一台主机，别名是eclipse.zhihu.com
www.zhihu.com.        120    IN    CNAME    eclipse.zhihu.com.
eclipse.zhihu.com.    600    IN    A    115.159.241.95
eclipse.zhihu.com.    600    IN    A    115.159.241.25
zhihu.com.        86400    IN    NS    ns4.dnsv4.com.
zhihu.com.        86400    IN    NS    ns3.dnsv4.com.
;; Received 148 bytes from 183.232.90.141#53(183.232.90.141) in 60 ms
</code></pre>
<h1>参考</h1>
<ul>
<li>《图解TCP/IP》</li>
<li><a href="http://www.cnblogs.com/xumenger/p/4508258.html">网络知识学习4—（DNS的作用）</a></li>
<li><a href="http://blog.csdn.net/crazw/article/details/8986581">域名解析中A记录、CNAME、MX记录、NS记录的区别和联系</a></li>
</ul>
<p>(完)</p>

  </div>
</article>

    </div>
  </div>
  <script src="/js/ui.js"></script>
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-113894191-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());
    gtag('config', 'UA-113894191-1');

  </script>
</body>

</html>
